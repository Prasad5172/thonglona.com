"use client";import{useFocusRing as Se}from"@react-aria/focus";import{useHover as Re}from"@react-aria/interactions";import D,{Fragment as q,createContext as Y,createRef as Pe,useCallback as se,useContext as Z,useEffect as pe,useMemo as N,useReducer as Ae,useRef as G,useState as Ee}from"react";import{useActivePress as he}from'../../hooks/use-active-press.js';import{useByComparator as De}from'../../hooks/use-by-comparator.js';import{useComputed as Ie}from'../../hooks/use-computed.js';import{useControllable as _e}from'../../hooks/use-controllable.js';import{useDisposables as K}from'../../hooks/use-disposables.js';import{useElementSize as Fe}from'../../hooks/use-element-size.js';import{useEvent as O}from'../../hooks/use-event.js';import{useId as ee}from'../../hooks/use-id.js';import{useIsoMorphicEffect as te}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Ce}from'../../hooks/use-latest-value.js';import{useOutsideClick as Me}from'../../hooks/use-outside-click.js';import{useResolveButtonType as we}from'../../hooks/use-resolve-button-type.js';import{useSyncRefs as H}from'../../hooks/use-sync-refs.js';import{useTextValue as ke}from'../../hooks/use-text-value.js';import{useTrackedPointer as Ue}from'../../hooks/use-tracked-pointer.js';import{useDisabled as Be}from'../../internal/disabled.js';import{FloatingProvider as Ne,useFloatingPanel as Ge,useFloatingPanelProps as Ve,useFloatingReference as He,useFloatingReferenceProps as je}from'../../internal/floating.js';import{FormFields as We}from'../../internal/form-fields.js';import{useProvidedId as ze}from'../../internal/id.js';import{Modal as Ke}from'../../internal/modal.js';import{OpenClosedProvider as Qe,State as Q,useOpenClosed as Xe}from'../../internal/open-closed.js';import{isDisabledReactIssue7711 as Je}from'../../utils/bugs.js';import{Focus as y,calculateActiveIndex as oe}from'../../utils/calculate-active-index.js';import{disposables as ne}from'../../utils/disposables.js';import{FocusableMode as $e,isFocusableElement as qe,sortByDomNode as Ye}from'../../utils/focus-management.js';import{match as V}from'../../utils/match.js';import{getOwnerDocument as Ze}from'../../utils/owner.js';import{RenderFeatures as ue,forwardRefWithAs as j,mergeProps as de,render as W}from'../../utils/render.js';import{useDescribedBy as et}from'../description/description.js';import{Keys as R}from'../keyboard.js';import{Label as tt,useLabelledBy as ot,useLabels as nt}from'../label/label.js';import{Portal as it}from'../portal/portal.js';var rt=(o=>(o[o.Open=0]="Open",o[o.Closed=1]="Closed",o))(rt||{}),at=(o=>(o[o.Single=0]="Single",o[o.Multi=1]="Multi",o))(at||{}),lt=(o=>(o[o.Pointer=0]="Pointer",o[o.Other=1]="Other",o))(lt||{}),st=(t=>(t[t.OpenListbox=0]="OpenListbox",t[t.CloseListbox=1]="CloseListbox",t[t.GoToOption=2]="GoToOption",t[t.Search=3]="Search",t[t.ClearSearch=4]="ClearSearch",t[t.RegisterOption=5]="RegisterOption",t[t.UnregisterOption=6]="UnregisterOption",t))(st||{});function ie(e,i=o=>o){let o=e.activeOptionIndex!==null?e.options[e.activeOptionIndex]:null,r=Ye(i(e.options.slice()),c=>c.dataRef.current.domRef.current),n=o?r.indexOf(o):null;return n===-1&&(n=null),{options:r,activeOptionIndex:n}}let pt={[1](e){return e.dataRef.current.disabled||e.listboxState===1?e:{...e,activeOptionIndex:null,listboxState:1}},[0](e){if(e.dataRef.current.disabled||e.listboxState===0)return e;let i=e.activeOptionIndex,{isSelected:o}=e.dataRef.current,r=e.options.findIndex(n=>o(n.dataRef.current.value));return r!==-1&&(i=r),{...e,listboxState:0,activeOptionIndex:i}},[2](e,i){var c,s,t,l,d;if(e.dataRef.current.disabled||e.listboxState===1)return e;let o={...e,searchQuery:"",activationTrigger:(c=i.trigger)!=null?c:1};if(i.focus===y.Nothing)return{...o,activeOptionIndex:null};if(i.focus===y.Specific)return{...o,activeOptionIndex:e.options.findIndex(p=>p.id===i.id)};if(i.focus===y.Previous){let p=e.activeOptionIndex;if(p!==null){let m=e.options[p].dataRef.current.domRef,T=oe(i,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:b=>b.id,resolveDisabled:b=>b.dataRef.current.disabled});if(T!==null){let b=e.options[T].dataRef.current.domRef;if(((s=m.current)==null?void 0:s.previousElementSibling)===b.current||((t=b.current)==null?void 0:t.previousElementSibling)===null)return{...o,activeOptionIndex:T}}}}else if(i.focus===y.Next){let p=e.activeOptionIndex;if(p!==null){let m=e.options[p].dataRef.current.domRef,T=oe(i,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:b=>b.id,resolveDisabled:b=>b.dataRef.current.disabled});if(T!==null){let b=e.options[T].dataRef.current.domRef;if(((l=m.current)==null?void 0:l.nextElementSibling)===b.current||((d=b.current)==null?void 0:d.nextElementSibling)===null)return{...o,activeOptionIndex:T}}}}let r=ie(e),n=oe(i,{resolveItems:()=>r.options,resolveActiveIndex:()=>r.activeOptionIndex,resolveId:p=>p.id,resolveDisabled:p=>p.dataRef.current.disabled});return{...o,...r,activeOptionIndex:n}},[3]:(e,i)=>{if(e.dataRef.current.disabled||e.listboxState===1)return e;let r=e.searchQuery!==""?0:1,n=e.searchQuery+i.value.toLowerCase(),s=(e.activeOptionIndex!==null?e.options.slice(e.activeOptionIndex+r).concat(e.options.slice(0,e.activeOptionIndex+r)):e.options).find(l=>{var d;return!l.dataRef.current.disabled&&((d=l.dataRef.current.textValue)==null?void 0:d.startsWith(n))}),t=s?e.options.indexOf(s):-1;return t===-1||t===e.activeOptionIndex?{...e,searchQuery:n}:{...e,searchQuery:n,activeOptionIndex:t,activationTrigger:1}},[4](e){return e.dataRef.current.disabled||e.listboxState===1||e.searchQuery===""?e:{...e,searchQuery:""}},[5]:(e,i)=>{let o={id:i.id,dataRef:i.dataRef},r=ie(e,n=>[...n,o]);return e.activeOptionIndex===null&&e.dataRef.current.isSelected(i.dataRef.current.value)&&(r.activeOptionIndex=r.options.indexOf(o)),{...e,...r}},[6]:(e,i)=>{let o=ie(e,r=>{let n=r.findIndex(c=>c.id===i.id);return n!==-1&&r.splice(n,1),r});return{...e,...o,activationTrigger:1}}},re=Y(null);re.displayName="ListboxActionsContext";function X(e){let i=Z(re);if(i===null){let o=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,X),o}return i}let J=Y(null);J.displayName="ListboxDataContext";function z(e){let i=Z(J);if(i===null){let o=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,z),o}return i}function ut(e,i){return V(i.type,pt,e,i)}let dt=q;function ct(e,i){var le;let o=Be(),{value:r,defaultValue:n,form:c,name:s,onChange:t,by:l,invalid:d=!1,disabled:p=o||!1,horizontal:m=!1,multiple:T=!1,...b}=e;const C=m?"horizontal":"vertical";let k=H(i),[P=T?[]:void 0,g]=_e(r,t,n),[h,v]=Ae(ut,{dataRef:Pe(),listboxState:1,options:[],searchQuery:"",activeOptionIndex:null,activationTrigger:1,optionsVisible:!1}),_=G({static:!1,hold:!1}),M=G(null),U=G(null),w=G(new Map),f=De(l),A=se(x=>V(u.mode,{[1]:()=>P.some(S=>f(S,x)),[0]:()=>f(P,x)}),[P]),u=N(()=>({...h,value:P,disabled:p,invalid:d,mode:T?1:0,orientation:C,compare:f,isSelected:A,optionsPropsRef:_,buttonRef:M,optionsRef:U,listRef:w}),[P,p,d,T,h,w]);te(()=>{h.dataRef.current=u},[u]),Me([u.buttonRef,u.optionsRef],(x,S)=>{var I;v({type:1}),qe(S,$e.Loose)||(x.preventDefault(),(I=u.buttonRef.current)==null||I.focus())},u.listboxState===0);let L=N(()=>({open:u.listboxState===0,disabled:p,invalid:d,value:P}),[u,p,P,d]),B=O(x=>{let S=u.options.find(I=>I.id===x);S&&$(S.dataRef.current.value)}),a=O(()=>{if(u.activeOptionIndex!==null){let{dataRef:x,id:S}=u.options[u.activeOptionIndex];$(x.current.value),v({type:2,focus:y.Specific,id:S})}}),E=O(()=>v({type:0})),F=O(()=>v({type:1})),ae=K(),fe=O((x,S,I)=>{ae.dispose(),ae.microTask(()=>x===y.Specific?v({type:2,focus:y.Specific,id:S,trigger:I}):v({type:2,focus:x,trigger:I}))}),Te=O((x,S)=>(v({type:5,id:x,dataRef:S}),()=>v({type:6,id:x}))),$=O(x=>V(u.mode,{[0](){return g==null?void 0:g(x)},[1](){let S=u.value.slice(),I=S.findIndex(Le=>f(Le,x));return I===-1?S.push(x):S.splice(I,1),g==null?void 0:g(S)}})),be=O(x=>v({type:3,value:x})),xe=O(()=>v({type:4})),me=N(()=>({onChange:$,registerOption:Te,goToOption:fe,closeListbox:F,openListbox:E,selectActiveOption:a,selectOption:B,search:be,clearSearch:xe}),[]),[Oe,ye]=nt({inherit:!0}),ge={ref:k},ve=se(()=>g==null?void 0:g(n),[g]);return D.createElement(ye,{value:Oe,props:{htmlFor:(le=u.buttonRef.current)==null?void 0:le.id},slot:{open:u.listboxState===0,disabled:p}},D.createElement(Ne,{enabled:u.listboxState===0},D.createElement(re.Provider,{value:me},D.createElement(J.Provider,{value:u},D.createElement(Qe,{value:V(u.listboxState,{[0]:Q.Open,[1]:Q.Closed})},s!=null&&P!=null&&D.createElement(We,{data:{[s]:P},form:c,onReset:ve}),W({ourProps:ge,theirProps:b,slot:L,defaultTag:dt,name:"Listbox"}))))))}let ft="button";function Tt(e,i){var f,A,u;let o=ee(),r=ze(),{id:n=r||`headlessui-listbox-button-${o}`,...c}=e,s=z("Listbox.Button"),t=X("Listbox.Button"),l=H(s.buttonRef,i,He()),d=je(),p=K(),m=O(L=>{switch(L.key){case R.Space:case R.Enter:case R.ArrowDown:L.preventDefault(),t.openListbox(),p.nextFrame(()=>{s.value||t.goToOption(y.First)});break;case R.ArrowUp:L.preventDefault(),t.openListbox(),p.nextFrame(()=>{s.value||t.goToOption(y.Last)});break}}),T=O(L=>{switch(L.key){case R.Space:L.preventDefault();break}}),b=O(L=>{if(Je(L.currentTarget))return L.preventDefault();s.listboxState===0?(t.closeListbox(),p.nextFrame(()=>{var B;return(B=s.buttonRef.current)==null?void 0:B.focus({preventScroll:!0})})):(L.preventDefault(),t.openListbox())}),C=ot([n]),k=et(),{isFocusVisible:P,focusProps:g}=Se({autoFocus:(f=e.autoFocus)!=null?f:!1}),{isHovered:h,hoverProps:v}=Re({isDisabled:(A=s.disabled)!=null?A:!1}),{pressed:_,pressProps:M}=he(),U=N(()=>{var L;return{open:s.listboxState===0,active:_||s.listboxState===0,disabled:s.disabled,invalid:s.invalid,value:s.value,hover:h,focus:P,autofocus:(L=e.autoFocus)!=null?L:!1}},[s.listboxState,s.disabled,s.value,h,P,_,s.invalid,e.autoFocus]),w=de(d(),{ref:l,id:n,type:we(e,s.buttonRef),"aria-haspopup":"listbox","aria-controls":(u=s.optionsRef.current)==null?void 0:u.id,"aria-expanded":s.listboxState===0,"aria-labelledby":C,"aria-describedby":k,disabled:s.disabled,onKeyDown:m,onKeyUp:T,onClick:b},g,v,M);return W({ourProps:w,theirProps:c,slot:U,defaultTag:ft,name:"Listbox.Button"})}let ce=Y(!1),bt="ul",xt=ue.RenderStrategy|ue.Static;function mt(e,i){var B;let o=ee(),{id:r=`headlessui-listbox-options-${o}`,anchor:n,modal:c,...s}=e;n!=null&&c==null?c=!0:c==null&&(c=!1);let t=z("Listbox.Options"),l=X("Listbox.Options"),d=Xe(),p=(()=>d!==null?(d&Q.Open)===Q.Open:t.listboxState===0)(),m=G(null);pe(()=>{var E;if(!((E=n==null?void 0:n.to)!=null&&E.includes("selection")))return;if(!p){m.current=null;return}let a=Array.from(t.listRef.current.values());m.current=a.findIndex(F=>(F==null?void 0:F.dataset.selected)===""),m.current===-1&&(m.current=a.findIndex(F=>(F==null?void 0:F.dataset.disabled)===void 0),l.goToOption(y.First))},[p,t.listRef]);let T=(()=>{if(n==null)return;if(t.listRef.current.size<=0)return{...n,inner:void 0};let a=Array.from(t.listRef.current.values());return{...n,inner:{listRef:{current:a},index:m.current}}})(),[b,C]=Ge(T),k=Ve(),P=H(t.optionsRef,i,b),g=K(),h=K();pe(()=>{var E;let a=t.optionsRef.current;a&&t.listboxState===0&&a!==((E=Ze(a))==null?void 0:E.activeElement)&&g.nextFrame(()=>a==null?void 0:a.focus({preventScroll:!0}))},[t.listboxState,t.optionsRef]);let v=O(a=>{switch(h.dispose(),a.key){case R.Space:if(t.searchQuery!=="")return a.preventDefault(),a.stopPropagation(),l.search(a.key);case R.Enter:if(a.preventDefault(),a.stopPropagation(),t.activeOptionIndex!==null){let{dataRef:E}=t.options[t.activeOptionIndex];l.onChange(E.current.value)}t.mode===0&&(l.closeListbox(),ne().nextFrame(()=>{var E;return(E=t.buttonRef.current)==null?void 0:E.focus({preventScroll:!0})}));break;case V(t.orientation,{vertical:R.ArrowDown,horizontal:R.ArrowRight}):return a.preventDefault(),a.stopPropagation(),l.goToOption(y.Next);case V(t.orientation,{vertical:R.ArrowUp,horizontal:R.ArrowLeft}):return a.preventDefault(),a.stopPropagation(),l.goToOption(y.Previous);case R.Home:case R.PageUp:return a.preventDefault(),a.stopPropagation(),l.goToOption(y.First);case R.End:case R.PageDown:return a.preventDefault(),a.stopPropagation(),l.goToOption(y.Last);case R.Escape:return a.preventDefault(),a.stopPropagation(),l.closeListbox(),g.nextFrame(()=>{var E;return(E=t.buttonRef.current)==null?void 0:E.focus({preventScroll:!0})});case R.Tab:a.preventDefault(),a.stopPropagation();break;default:a.key.length===1&&(l.search(a.key),h.setTimeout(()=>l.clearSearch(),350));break}}),_=Ie(()=>{var a;return(a=t.buttonRef.current)==null?void 0:a.id},[t.buttonRef.current]),M=N(()=>({open:t.listboxState===0}),[t]),U=de(k(),{id:r,ref:P,"aria-activedescendant":t.activeOptionIndex===null||(B=t.options[t.activeOptionIndex])==null?void 0:B.id,"aria-multiselectable":t.mode===1?!0:void 0,"aria-labelledby":_,"aria-orientation":t.orientation,onKeyDown:v,role:"listbox",tabIndex:0,style:{...C,"--button-width":Fe(t.buttonRef,!0).width}}),w=c?Ke:n?it:q,f=c?{enabled:t.listboxState===0}:{},[A,u]=Ee(t.value);t.value!==A&&t.listboxState===0&&t.mode!==1&&u(t.value);let L=O(a=>t.compare(A,a));return D.createElement(w,{...f},D.createElement(J.Provider,{value:t.mode===1?t:{...t,isSelected:L}},W({ourProps:U,theirProps:s,slot:M,defaultTag:bt,features:xt,visible:p,name:"Listbox.Options"})))}let Ot="li";function yt(e,i){let o=ee(),{id:r=`headlessui-listbox-option-${o}`,disabled:n=!1,value:c,...s}=e,t=Z(ce)===!0,l=z("Listbox.Option"),d=X("Listbox.Option"),p=l.activeOptionIndex!==null?l.options[l.activeOptionIndex].id===r:!1,m=l.isSelected(c),T=G(null),b=ke(T),C=Ce({disabled:n,value:c,domRef:T,get textValue(){return b()}}),k=H(i,T,f=>{f?l.listRef.current.set(r,f):l.listRef.current.delete(r)});te(()=>{if(l.listboxState!==0||!p||l.activationTrigger===0)return;let f=ne();return f.requestAnimationFrame(()=>{var A,u;(u=(A=T.current)==null?void 0:A.scrollIntoView)==null||u.call(A,{block:"nearest"})}),f.dispose},[T,p,l.listboxState,l.activationTrigger,l.activeOptionIndex]),te(()=>{if(!t)return d.registerOption(r,C)},[C,r,t]);let P=O(f=>{if(n)return f.preventDefault();d.onChange(c),l.mode===0&&(d.closeListbox(),ne().nextFrame(()=>{var A;return(A=l.buttonRef.current)==null?void 0:A.focus({preventScroll:!0})}))}),g=O(()=>{if(n)return d.goToOption(y.Nothing);d.goToOption(y.Specific,r)}),h=Ue(),v=O(f=>{h.update(f),!n&&(p||d.goToOption(y.Specific,r,0))}),_=O(f=>{h.wasMoved(f)&&(n||p||d.goToOption(y.Specific,r,0))}),M=O(f=>{h.wasMoved(f)&&(n||p&&d.goToOption(y.Nothing))}),U=N(()=>({active:p,focus:p,selected:m,disabled:n,selectedOption:m&&t}),[p,m,n,t]),w=t?{}:{id:r,ref:k,role:"option",tabIndex:n===!0?void 0:-1,"aria-disabled":n===!0?!0:void 0,"aria-selected":m,disabled:void 0,onClick:P,onFocus:g,onPointerEnter:v,onMouseEnter:v,onPointerMove:_,onMouseMove:_,onPointerLeave:M,onMouseLeave:M};return!m&&t?null:W({ourProps:w,theirProps:s,slot:U,defaultTag:Ot,name:"Listbox.Option"})}let gt=q;function vt(e,i){let{options:o,placeholder:r,...n}=e,s={ref:H(i)},t=z("ListboxSelectedOption"),l=N(()=>({}),[]),d=t.value===void 0||t.value===null||t.mode===1&&Array.isArray(t.value)&&t.value.length===0;return D.createElement(ce.Provider,{value:!0},W({ourProps:s,theirProps:{...n,children:D.createElement(D.Fragment,null,r&&d?r:o)},slot:l,defaultTag:gt,name:"ListboxSelectedOption"}))}let Lt=j(ct),St=j(Tt),Rt=tt,Pt=j(mt),At=j(yt),so=j(vt),po=Object.assign(Lt,{Button:St,Label:Rt,Options:Pt,Option:At});export{po as Listbox,St as ListboxButton,Rt as ListboxLabel,At as ListboxOption,Pt as ListboxOptions,so as ListboxSelectedOption};
