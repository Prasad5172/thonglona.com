"use client";import{useFocusRing as Oe}from"@react-aria/focus";import{useHover as Ce}from"@react-aria/interactions";import y,{Fragment as Me,createContext as Z,createRef as me,useContext as ee,useEffect as te,useMemo as h,useReducer as xe,useRef as q,useState as ye}from"react";import{useActivePress as _e}from'../../hooks/use-active-press.js';import{useEvent as S}from'../../hooks/use-event.js';import{useEventListener as Le}from'../../hooks/use-event-listener.js';import{useId as oe}from'../../hooks/use-id.js';import{useIsoMorphicEffect as Ie}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Ee}from'../../hooks/use-latest-value.js';import{useOutsideClick as Be}from'../../hooks/use-outside-click.js';import{useOwnerDocument as pe}from'../../hooks/use-owner.js';import{useResolveButtonType as he}from'../../hooks/use-resolve-button-type.js';import{useMainTreeNode as De,useRootContainers as Ge}from'../../hooks/use-root-containers.js';import{optionalRef as He,useSyncRefs as X}from'../../hooks/use-sync-refs.js';import{Direction as H,useTabDirection as be}from'../../hooks/use-tab-direction.js';import{FloatingProvider as Ne,useFloatingPanel as ke,useFloatingPanelProps as we,useFloatingReference as Ue}from'../../internal/floating.js';import{Hidden as se,HiddenFeatures as ue}from'../../internal/hidden.js';import{Modal as ge,ModalFeatures as We}from'../../internal/modal.js';import{OpenClosedProvider as Ve,State as Y,useOpenClosed as Se}from'../../internal/open-closed.js';import{isDisabledReactIssue7711 as Ae}from'../../utils/bugs.js';import{Focus as N,FocusResult as ie,FocusableMode as Ke,focusIn as U,getFocusableElements as fe,isFocusableElement as je}from'../../utils/focus-management.js';import{match as W}from'../../utils/match.js';import'../../utils/micro-task.js';import{getOwnerDocument as $e}from'../../utils/owner.js';import{RenderFeatures as re,forwardRefWithAs as z,mergeProps as Pe,render as Q,useMergeRefsFn as Je}from'../../utils/render.js';import{FocusTrapFeatures as Xe}from'../focus-trap/focus-trap.js';import{Keys as V}from'../keyboard.js';import{Portal as Re,useNestedPortals as Ye}from'../portal/portal.js';var qe=(f=>(f[f.Open=0]="Open",f[f.Closed=1]="Closed",f))(qe||{}),ze=(n=>(n[n.TogglePopover=0]="TogglePopover",n[n.ClosePopover=1]="ClosePopover",n[n.SetButton=2]="SetButton",n[n.SetButtonId=3]="SetButtonId",n[n.SetPanel=4]="SetPanel",n[n.SetPanelId=5]="SetPanelId",n))(ze||{});let Qe={[0]:e=>{let l={...e,popoverState:W(e.popoverState,{[0]:1,[1]:0})};return l.popoverState===0&&(l.__demoMode=!1),l},[1](e){return e.popoverState===1?e:{...e,popoverState:1}},[2](e,l){return e.button===l.button?e:{...e,button:l.button}},[3](e,l){return e.buttonId===l.buttonId?e:{...e,buttonId:l.buttonId}},[4](e,l){return e.panel===l.panel?e:{...e,panel:l.panel}},[5](e,l){return e.panelId===l.panelId?e:{...e,panelId:l.panelId}}},de=Z(null);de.displayName="PopoverContext";function ne(e){let l=ee(de);if(l===null){let f=new Error(`<${e} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(f,ne),f}return l}let le=Z(null);le.displayName="PopoverAPIContext";function ce(e){let l=ee(le);if(l===null){let f=new Error(`<${e} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(f,ce),f}return l}let ve=Z(null);ve.displayName="PopoverGroupContext";function Fe(){return ee(ve)}let ae=Z(null);ae.displayName="PopoverPanelContext";function Ze(){return ee(ae)}function et(e,l){return W(l.type,Qe,e,l)}let tt="div";function ot(e,l){var P;let{__demoMode:f=!1,...O}=e,C=q(null),a=X(l,He(o=>{C.current=o})),n=q([]),x=xe(et,{__demoMode:f,popoverState:f?0:1,buttons:n,button:null,buttonId:null,panel:null,panelId:null,beforePanelSentinel:me(),afterPanelSentinel:me()}),[{popoverState:t,button:p,buttonId:A,panel:s,panelId:k,beforePanelSentinel:m,afterPanelSentinel:T},d]=x,i=pe((P=C.current)!=null?P:p),b=h(()=>{if(!p||!s)return!1;for(let E of document.querySelectorAll("body > *"))if(Number(E==null?void 0:E.contains(p))^Number(E==null?void 0:E.contains(s)))return!0;let o=fe(),u=o.indexOf(p),c=(u+o.length-1)%o.length,F=(u+1)%o.length,r=o[c],v=o[F];return!s.contains(r)&&!s.contains(v)},[p,s]),M=Ee(A),g=Ee(k),L=h(()=>({buttonId:M,panelId:g,close:()=>d({type:1})}),[M,g,d]),R=Fe(),_=R==null?void 0:R.registerPopover,K=S(()=>{var o;return(o=R==null?void 0:R.isFocusWithinPopoverGroup())!=null?o:(i==null?void 0:i.activeElement)&&((p==null?void 0:p.contains(i.activeElement))||(s==null?void 0:s.contains(i.activeElement)))});te(()=>_==null?void 0:_(L),[_,L]);let[j,$]=Ye(),I=Ge({mainTreeNodeRef:R==null?void 0:R.mainTreeNodeRef,portals:j,defaultContainers:[p,s]});Le(i==null?void 0:i.defaultView,"focus",o=>{var u,c,F,r;o.target!==window&&o.target instanceof HTMLElement&&t===0&&(K()||p&&s&&(I.contains(o.target)||(c=(u=m.current)==null?void 0:u.contains)!=null&&c.call(u,o.target)||(r=(F=T.current)==null?void 0:F.contains)!=null&&r.call(F,o.target)||d({type:1})))},!0),Be(I.resolveContainers,(o,u)=>{d({type:1}),je(u,Ke.Loose)||(o.preventDefault(),p==null||p.focus())},t===0);let B=S(o=>{d({type:1});let u=(()=>o?o instanceof HTMLElement?o:"current"in o&&o.current instanceof HTMLElement?o.current:p:p)();u==null||u.focus()}),D=h(()=>({close:B,isPortalled:b}),[B,b]),w=h(()=>({open:t===0,close:B}),[t,B]),J={ref:a};return y.createElement(Ne,null,y.createElement(ae.Provider,{value:null},y.createElement(de.Provider,{value:x},y.createElement(le.Provider,{value:D},y.createElement(Ve,{value:W(t,{[0]:Y.Open,[1]:Y.Closed})},y.createElement($,null,Q({ourProps:J,theirProps:O,slot:w,defaultTag:tt,name:"Popover"}),y.createElement(I.MainTreeNode,null)))))))}let rt="button";function nt(e,l){var c,F;let f=oe(),{id:O=`headlessui-popover-button-${f}`,...C}=e,[a,n]=ne("Popover.Button"),{isPortalled:x}=ce("Popover.Button"),t=q(null),p=`headlessui-focus-sentinel-${oe()}`,A=Fe(),s=A==null?void 0:A.closeOthers,m=Ze()!==null;te(()=>{if(!m)return n({type:3,buttonId:O}),()=>{n({type:3,buttonId:null})}},[m,O,n]);let[T]=ye(()=>Symbol()),d=X(t,l,Ue(),m?null:r=>{if(r)a.buttons.current.push(T);else{let v=a.buttons.current.indexOf(T);v!==-1&&a.buttons.current.splice(v,1)}a.buttons.current.length>1&&console.warn("You are already using a <Popover.Button /> but only 1 <Popover.Button /> is supported."),r&&n({type:2,button:r})}),i=X(t,l),b=pe(t),M=S(r=>{var v,E,G;if(m){if(a.popoverState===1)return;switch(r.key){case V.Space:case V.Enter:r.preventDefault(),(E=(v=r.target).click)==null||E.call(v),n({type:1}),(G=a.button)==null||G.focus();break}}else switch(r.key){case V.Space:case V.Enter:r.preventDefault(),r.stopPropagation(),a.popoverState===1&&(s==null||s(a.buttonId)),n({type:0});break;case V.Escape:if(a.popoverState!==0)return s==null?void 0:s(a.buttonId);if(!t.current||b!=null&&b.activeElement&&!t.current.contains(b.activeElement))return;r.preventDefault(),r.stopPropagation(),n({type:1});break}}),g=S(r=>{m||r.key===V.Space&&r.preventDefault()}),L=S(r=>{var v,E;Ae(r.currentTarget)||e.disabled||(m?(n({type:1}),(v=a.button)==null||v.focus()):(r.preventDefault(),r.stopPropagation(),a.popoverState===1&&(s==null||s(a.buttonId)),n({type:0}),(E=a.button)==null||E.focus()))}),R=S(r=>{r.preventDefault(),r.stopPropagation()}),{isFocusVisible:_,focusProps:K}=Oe({autoFocus:(c=e.autoFocus)!=null?c:!1}),{isHovered:j,hoverProps:$}=Ce({isDisabled:(F=e.disabled)!=null?F:!1}),{pressed:I,pressProps:B}=_e(),D=a.popoverState===0,w=h(()=>{var r;return{open:D,active:I||D,hover:j,focus:_,autofocus:(r=e.autoFocus)!=null?r:!1}},[D,j,_,I,e.autoFocus]),J=he(e,t),P=m?Pe({ref:i,type:J,onKeyDown:M,onClick:L},K,$,B):Pe({ref:d,id:a.buttonId,type:J,"aria-expanded":a.popoverState===0,"aria-controls":a.panel?a.panelId:void 0,onKeyDown:M,onKeyUp:g,onClick:L,onMouseDown:R},K,$,B),o=be(),u=S(()=>{let r=a.panel;if(!r)return;function v(){W(o.current,{[H.Forwards]:()=>U(r,N.First),[H.Backwards]:()=>U(r,N.Last)})===ie.Error&&U(fe().filter(G=>G.dataset.headlessuiFocusGuard!=="true"),W(o.current,{[H.Forwards]:N.Next,[H.Backwards]:N.Previous}),{relativeTo:a.button})}v()});return y.createElement(y.Fragment,null,Q({ourProps:P,theirProps:C,slot:w,defaultTag:rt,name:"Popover.Button"}),D&&!m&&x&&y.createElement(se,{id:p,features:ue.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:u}))}let lt="div",at=re.RenderStrategy|re.Static;function pt(e,l){let f=oe(),{id:O=`headlessui-popover-overlay-${f}`,...C}=e,[{popoverState:a},n]=ne("Popover.Overlay"),x=X(l),t=Se(),p=(()=>t!==null?(t&Y.Open)===Y.Open:a===0)(),A=S(m=>{if(Ae(m.currentTarget))return m.preventDefault();n({type:1})}),s=h(()=>({open:a===0}),[a]);return Q({ourProps:{ref:x,id:O,"aria-hidden":!0,onClick:A},theirProps:C,slot:s,defaultTag:lt,features:at,visible:p,name:"Popover.Overlay"})}let st="div",ut=re.RenderStrategy|re.Static;function it(e,l){let f=oe(),{id:O=`headlessui-popover-panel-${f}`,focus:C=!1,anchor:a,modal:n,...x}=e,[t,p]=ne("Popover.Panel"),{close:A,isPortalled:s}=ce("Popover.Panel"),k=`headlessui-focus-sentinel-before-${f}`,m=`headlessui-focus-sentinel-after-${f}`,T=q(null),[d,i]=ke(a),b=we();a!=null&&n==null?n=!0:n==null&&(n=!1);let M=X(T,l,d,P=>{p({type:4,panel:P})}),g=pe(T),L=Je();Ie(()=>(p({type:5,panelId:O}),()=>{p({type:5,panelId:null})}),[O,p]);let R=Se(),_=(()=>R!==null?(R&Y.Open)===Y.Open:t.popoverState===0)(),K=S(P=>{var o;switch(P.key){case V.Escape:if(t.popoverState!==0||!T.current||g!=null&&g.activeElement&&!T.current.contains(g.activeElement))return;P.preventDefault(),P.stopPropagation(),p({type:1}),(o=t.button)==null||o.focus();break}});te(()=>{var P;e.static||t.popoverState===1&&((P=e.unmount)==null||P)&&p({type:4,panel:null})},[t.popoverState,e.unmount,e.static,p]),te(()=>{if(t.__demoMode||!C||t.popoverState!==0||!T.current)return;let P=g==null?void 0:g.activeElement;T.current.contains(P)||U(T.current,N.First)},[t.__demoMode,C,T,t.popoverState]);let j=h(()=>({open:t.popoverState===0,close:A}),[t,A]),$=Pe(b(),{ref:M,id:O,onKeyDown:K,onBlur:C&&t.popoverState===0?P=>{var u,c,F,r,v;let o=P.relatedTarget;o&&T.current&&((u=T.current)!=null&&u.contains(o)||(p({type:1}),((F=(c=t.beforePanelSentinel.current)==null?void 0:c.contains)!=null&&F.call(c,o)||(v=(r=t.afterPanelSentinel.current)==null?void 0:r.contains)!=null&&v.call(r,o))&&o.focus({preventScroll:!0})))}:void 0,tabIndex:-1,...i?{style:i}:{}}),I=be(),B=S(()=>{let P=T.current;if(!P)return;function o(){W(I.current,{[H.Forwards]:()=>{var c;U(P,N.First)===ie.Error&&((c=t.afterPanelSentinel.current)==null||c.focus())},[H.Backwards]:()=>{var u;(u=t.button)==null||u.focus({preventScroll:!0})}})}o()}),D=S(()=>{let P=T.current;if(!P)return;function o(){W(I.current,{[H.Forwards]:()=>{var E;if(!t.button)return;let u=fe(),c=u.indexOf(t.button),F=u.slice(0,c+1),v=[...u.slice(c+1),...F];for(let G of v.slice())if(G.dataset.headlessuiFocusGuard==="true"||(E=t.panel)!=null&&E.contains(G)){let Te=v.indexOf(G);Te!==-1&&v.splice(Te,1)}U(v,N.First,{sorted:!1})},[H.Backwards]:()=>{var c;U(P,N.Previous)===ie.Error&&((c=t.button)==null||c.focus())}})}o()}),w=n?ge:a?Re:Me,J=n?{focusTrapFeatures:Xe.None,features:We.ScrollLock,enabled:t.popoverState===0}:{};return(w===Re||w===ge)&&(s=!0),y.createElement(ae.Provider,{value:O},y.createElement(le.Provider,{value:{close:A,isPortalled:s}},y.createElement(w,{...J},_&&s&&y.createElement(se,{id:k,ref:t.beforePanelSentinel,features:ue.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:B}),Q({mergeRefs:L,ourProps:$,theirProps:x,slot:j,defaultTag:st,features:ut,visible:_,name:"Popover.Panel"}),_&&s&&y.createElement(se,{id:m,ref:t.afterPanelSentinel,features:ue.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:D}))))}let ft="div";function Pt(e,l){let f=q(null),O=X(f,l),[C,a]=ye([]),n=De(),x=S(d=>{a(i=>{let b=i.indexOf(d);if(b!==-1){let M=i.slice();return M.splice(b,1),M}return i})}),t=S(d=>(a(i=>[...i,d]),()=>x(d))),p=S(()=>{var b;let d=$e(f);if(!d)return!1;let i=d.activeElement;return(b=f.current)!=null&&b.contains(i)?!0:C.some(M=>{var g,L;return((g=d.getElementById(M.buttonId.current))==null?void 0:g.contains(i))||((L=d.getElementById(M.panelId.current))==null?void 0:L.contains(i))})}),A=S(d=>{for(let i of C)i.buttonId.current!==d&&i.close()}),s=h(()=>({registerPopover:t,unregisterPopover:x,isFocusWithinPopoverGroup:p,closeOthers:A,mainTreeNodeRef:n.mainTreeNodeRef}),[t,x,p,A,n.mainTreeNodeRef]),k=h(()=>({}),[]),m=e,T={ref:O};return y.createElement(ve.Provider,{value:s},Q({ourProps:T,theirProps:m,slot:k,defaultTag:ft,name:"Popover.Group"}),y.createElement(n.MainTreeNode,null))}let dt=z(ot),ct=z(nt),vt=z(pt),Tt=z(it),mt=z(Pt),Jt=Object.assign(dt,{Button:ct,Overlay:vt,Panel:Tt,Group:mt});export{Jt as Popover,ct as PopoverButton,mt as PopoverGroup,vt as PopoverOverlay,Tt as PopoverPanel};
